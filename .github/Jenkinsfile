pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-northeast-2'
        AWS_ACCOUNT_ID = '490913547024'
        DOCKER_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

        // Git 정보
        GIT_COMMIT_SHORT = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()

        // Jenkins에서 AWS 자격증명을 위한 credential ID (Jenkins에서 설정 필요)
        AWS_CREDENTIALS = 'aws-ecr-credentials'
    }

    parameters {
        choice(
            name: 'TARGET_BRANCH',
            choices: ['release/1.0.0', 'main', 'develop'],
            description: '빌드할 브랜치 선택'
        )
        booleanParam(
            name: 'FORCE_BUILD_ALL',
            defaultValue: false,
            description: '모든 모듈 강제 빌드 여부'
        )
        booleanParam(
            name: 'INSTALL_TOOLS',
            defaultValue: true,
            description: 'Docker, AWS CLI 설치 여부'
        )
    }

    stages {
        stage('Setup Tools') {
            when {
                params('INSTALL_TOOLS')
            }
            steps {
                script {
                    echo "Setting up Docker and AWS CLI..."

                    // Docker 설치 확인 및 설치
                    def dockerExists = sh(script: 'command -v docker', returnStatus: true) == 0
                    if (!dockerExists) {
                        echo "Installing Docker..."
                        sh '''
                            # Docker 설치 (Ubuntu/Debian 기준)
                            sudo apt-get update -y
                            sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

                            # Docker GPG 키 추가
                            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

                            # Docker 리포지토리 추가
                            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

                            # Docker 설치
                            sudo apt-get update -y
                            sudo apt-get install -y docker-ce docker-ce-cli containerd.io

                            # Jenkins 사용자를 docker 그룹에 추가
                            sudo usermod -aG docker jenkins

                            # Docker 서비스 시작
                            sudo systemctl start docker
                            sudo systemctl enable docker
                        '''
                    } else {
                        echo "Docker already installed"
                    }

                    // AWS CLI 설치 확인 및 설치
                    def awsCliExists = sh(script: 'command -v aws', returnStatus: true) == 0
                    if (!awsCliExists) {
                        echo "Installing AWS CLI..."
                        sh '''
                            # AWS CLI v2 설치
                            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                            unzip -q awscliv2.zip
                            sudo ./aws/install
                            rm -rf awscliv2.zip aws/
                        '''
                    } else {
                        echo "AWS CLI already installed"
                    }

                    // 버전 확인
                    sh '''
                        echo "=== Installed Tool Versions ==="
                        docker --version
                        aws --version
                        echo "=============================="
                    '''
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
                script {
                    // 변경된 파일들 확인
                    def changedFiles = sh(
                        script: "git diff --name-only HEAD~1 HEAD || git ls-files",
                        returnStdout: true
                    ).trim().split('\n')

                    echo "Changed files: ${changedFiles}"
                    env.CHANGED_FILES = changedFiles.join(' ')
                }
            }
        }

        stage('Determine Changed Modules') {
            steps {
                script {
                    // 모듈 정보 정의 (GitHub Actions workflow 기반)
                    def modules = [
                        'auth': [
                            'path': 'msa-auth-service',
                            'ecrRepo': 'auth-service',
                            'containerName': 'auth-service'
                        ],
                        'common': [
                            'path': 'msa-common-service',
                            'ecrRepo': 'common-service',
                            'containerName': 'msa-common-service'
                        ],
                        'order': [
                            'path': 'msa-order-service',
                            'ecrRepo': 'order-service',
                            'containerName': 'msa-order-service'
                        ],
                        'payment': [
                            'path': 'msa-payment-service',
                            'ecrRepo': 'payment-service',
                            'containerName': 'msa-payment-service'
                        ],
                        'store': [
                            'path': 'msa-store-service',
                            'ecrRepo': 'store-service',
                            'containerName': 'msa-store-service'
                        ],
                        'user': [
                            'path': 'msa-user-service',
                            'ecrRepo': 'user-service',
                            'containerName': 'msa-user-service'
                        ]
                    ]

                    def changedModules = []
                    def changedFiles = env.CHANGED_FILES.split(' ')

                    if (params.FORCE_BUILD_ALL) {
                        changedModules = modules.keySet().toList()
                        echo "Force build all modules enabled"
                    } else {
                        modules.each { moduleName, moduleInfo ->
                            def hasChanges = changedFiles.any { file ->
                                file.startsWith(moduleInfo.path + '/')
                            }
                            if (hasChanges) {
                                changedModules.add(moduleName)
                            }
                        }
                    }

                    env.CHANGED_MODULES = changedModules.join(',')
                    env.MODULES_JSON = writeJSON returnText: true, json: modules

                    echo "Changed modules: ${changedModules}"

                    if (changedModules.isEmpty()) {
                        echo "No modules changed. Skipping build."
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                }
            }
        }

        stage('Build and Deploy Changed Modules') {
            when {
                not {
                    environment name: 'CHANGED_MODULES', value: ''
                }
            }
            steps {
                script {
                    def modules = readJSON text: env.MODULES_JSON
                    def changedModules = env.CHANGED_MODULES.split(',')

                    // AWS 자격증명 및 ECR 로그인
                    withCredentials([
                        [
                            $class: 'AmazonWebServicesCredentialsBinding',
                            credentialsId: env.AWS_CREDENTIALS,
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                        ]
                    ]) {
                        sh """
                            aws configure set aws_access_key_id \$AWS_ACCESS_KEY_ID
                            aws configure set aws_secret_access_key \$AWS_SECRET_ACCESS_KEY
                            aws configure set default.region ${env.AWS_REGION}

                            # ECR 로그인
                            aws ecr get-login-password --region ${env.AWS_REGION} | \
                            docker login --username AWS --password-stdin ${env.DOCKER_REGISTRY}
                        """
                    }

                    // 각 변경된 모듈에 대해 순차 실행 (리소스 절약)
                    changedModules.each { moduleName ->
                        def moduleInfo = modules[moduleName]
                        def servicePath = moduleInfo.path
                        def ecrRepo = moduleInfo.ecrRepo
                        def containerName = moduleInfo.containerName

                        stage("Build ${moduleName}") {
                            echo "Building module: ${moduleName}"

                            // Gradle 빌드
                            sh """
                                echo "Building ${servicePath}..."
                                chmod +x ./gradlew
                                ./gradlew :${servicePath}:build --no-daemon --stacktrace
                            """

                            // Docker 빌드 및 푸시
                            def imageTag = "${env.DOCKER_REGISTRY}/${ecrRepo}:${env.GIT_COMMIT_SHORT}"
                            def latestTag = "${env.DOCKER_REGISTRY}/${ecrRepo}:latest"

                            sh """
                                echo "Building Docker image: ${imageTag}"

                                # Docker 빌드 및 푸시
                                docker build --platform linux/amd64 \
                                    -t ${imageTag} \
                                    -t ${latestTag} \
                                    -f ./${servicePath}/Dockerfile .

                                docker push ${imageTag}
                                docker push ${latestTag}

                                echo "Successfully pushed: ${imageTag}"
                            """

                            // 배포 단계 (EKS - 필요시 주석 해제)
                            /*
                            sh """
                                echo "Deploying to Kubernetes..."
                                aws eks update-kubeconfig --name Groom-EKS-Cluster --region ${env.AWS_REGION}
                                kubectl set image deployment/${containerName} \
                                    ${containerName}=${imageTag} -n default
                                kubectl rollout status deployment/${containerName} -n default
                            """
                            */

                            echo "Module ${moduleName} build completed successfully!"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            // Docker 이미지 정리
            sh '''
                echo "Cleaning up Docker images..."
                docker system prune -f || true
                docker image prune -f || true
            '''
        }
        success {
            echo "🎉 Pipeline completed successfully!"
            script {
                if (env.CHANGED_MODULES) {
                    def modules = env.CHANGED_MODULES.split(',')
                    echo "✅ Successfully built and deployed modules: ${modules.join(', ')}"

                    // 빌드된 이미지 정보 출력
                    modules.each { module ->
                        echo "📦 ${module}: ${env.DOCKER_REGISTRY}/${module}-service:${env.GIT_COMMIT_SHORT}"
                    }
                } else {
                    echo "ℹ️ No changes detected, pipeline completed without build."
                }
            }
        }
        failure {
            echo "❌ Pipeline failed!"
            echo "Please check the logs for detailed error information."
        }
    }

    triggers {
        // GitHub webhook 트리거
        githubPush()

        // 또는 SCM 폴링 (5분마다 체크) - 선택사항
        // pollSCM('H/5 * * * *')
    }
}
