<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì£¼ë¬¸ ê²°ì œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Toss Payments SDK -->
  <script src="https://js.tosspayments.com/v1/payment"></script>
  <style>
    :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    body { margin: 0; background:#0b0c10; color:#f5f7fb; }
    .wrap { max-width: 860px; margin: 40px auto; padding: 24px; }
    .card { background:#14161b; border:1px solid #22252c; border-radius:16px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .title { font-size: 22px; margin: 0 0 12px; }
    .sub { color:#aab1bd; margin: 0 0 20px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #22252c; text-align:left; }
    th { color:#cfd6e4; font-weight:600; }
    tfoot td { border-top:1px solid #2a2f37; font-weight:700; }
    .qty, .price, .lineTotal, .right { text-align: right; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; background:#1e2633; color:#a8d0ff; font-size:12px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; margin-top: 18px; }
    .row .box { flex:1; min-width: 220px; background:#101218; border:1px solid #1f2330; border-radius:12px; padding:12px 14px; }
    .label { color:#9aa3b2; font-size:12px; }
    .val { font-size:16px; margin-top:4px; }
    .btns { display:flex; gap:12px; margin-top: 24px; }
    .btn {
      flex:1; padding:14px 16px; border-radius:12px; border:1px solid transparent;
      font-weight:700; cursor:pointer; transition: transform .02s;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background:#3b82f6; color:white; }
    .btn-outline { background:#0b0c10; color:#c6cbd7; border-color:#2c3340; }
    .help { color:#8c94a3; font-size:12px; margin-top: 10px; }
    code { background:#0e1116; padding:2px 6px; border-radius:6px; border:1px solid #1f2330; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 class="title">ğŸ§¾ ì£¼ë¬¸ í™•ì¸ & ê²°ì œ</h1>
    <p class="sub">ìŠ¤í† ì–´ <span id="storeName" class="badge"></span> ì˜ ì£¼ë¬¸ ë‚´ì—­ì…ë‹ˆë‹¤.</p>

    <table>
      <thead>
      <tr>
        <th>ë©”ë‰´ëª…</th>
        <th class="price">ê°€ê²©(KRW)</th>
        <th class="qty">ìˆ˜ëŸ‰</th>
        <th class="lineTotal">ê¸ˆì•¡(KRW)</th>
      </tr>
      </thead>
      <tbody id="itemTbody"></tbody>
      <tfoot>
      <tr>
        <td>ì´ ìˆ˜ëŸ‰</td>
        <td></td>
        <td class="qty" id="totalQuantity">0</td>
        <td class="lineTotal" id="totalAmount">0</td>
      </tr>
      </tfoot>
    </table>

    <div class="row">
      <div class="box">
        <div class="label">ì£¼ë¬¸ëª… (orderName)</div>
        <div class="val" id="orderName">-</div>
      </div>
      <div class="box">
        <div class="label">ì£¼ë¬¸ë²ˆí˜¸ (orderId)</div>
        <div class="val" id="orderId">-</div>
      </div>
      <div class="box">
        <div class="label">ê²°ì œ ê¸ˆì•¡ (amount)</div>
        <div class="val" id="amountView">0 ì›</div>
      </div>
    </div>

    <div class="btns">
      <button id="payBtn" class="btn btn-primary">ê²°ì œí•˜ê¸°</button>
      <button id="cancelBtn" class="btn btn-outline">ê²°ì œ ì·¨ì†Œí•˜ê¸°</button>
    </div>

    <p class="help">
      â€¢ ì£¼ë¬¸ ì „ ë©”ë‰´ì™€ ìˆ˜ëŸ‰ì„ ì˜ í™•ì¸í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. <br/>
      â€¢ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ 02-1111-1111ë¡œ ì „í™”ì£¼ì„¸ìš”.
    </p>
  </div>
</div>

<script>
  const PAYMENT_API_BASE = "http://localhost:8086";
  const ORIGIN = location.origin;

  // URL íŒŒë¼ë¯¸í„°
  const qs = new URLSearchParams(location.search);
  const orderId    = qs.get("orderId");
  const customerId = qs.get("customerId");

  // Toss
  const TOSS_CLIENT_KEY = "test_ck_Ba5PzR0Arn9bqEYORBDXVvmYnNeD";
  // ê²Œì´íŠ¸ì›¨ì´ ì—†ì„ ë•ŒëŠ” customerIdë¥¼ ì¿¼ë¦¬ë¡œ ê°™ì´ ë„˜ê²¨ì„œ ì„œë²„ì—ì„œ ì½ê²Œ í•¨
  const SUCCESS_URL = `${ORIGIN}/payments/success?customerId=${encodeURIComponent(customerId || "")}`;
  const FAIL_URL    = `${ORIGIN}/payments/fail?customerId=${encodeURIComponent(customerId || "")}`;

  // API ê²½ë¡œ
  const CHECKOUT_API = (orderId, customerId) =>
          `${PAYMENT_API_BASE}/payments/checkout?orderId=${encodeURIComponent(orderId)}&customerId=${encodeURIComponent(customerId)}`;
  const ORDER_CANCEL_API = (orderId) =>
          `/orders/${encodeURIComponent(orderId)}/cancel`;

  // ì—˜ë¦¬ë¨¼íŠ¸
  const storeNameEl   = document.getElementById('storeName');
  const itemTbody     = document.getElementById('itemTbody');
  const totalQtyEl    = document.getElementById('totalQuantity');
  const totalAmtEl    = document.getElementById('totalAmount');
  const orderIdEl     = document.getElementById('orderId');
  const orderNameEl   = document.getElementById('orderName');
  const amountViewEl  = document.getElementById('amountView');

  // í™”ë©´ ìƒíƒœ
  let ORDER = null; // ì„œë²„ì—ì„œ ë°›ì€ ì£¼ë¬¸ì„œ

  const nf = (n) => Number(n || 0).toLocaleString('ko-KR');

  async function loadOrder() {
    if (!orderId || !customerId) {
      itemTbody.innerHTML =
              `<tr><td colspan="4">orderId ë˜ëŠ” customerIdê°€ ì—†ìŠµë‹ˆë‹¤. URLì— ?orderId=...&customerId=... ë¡œ ì ‘ê·¼í•˜ì„¸ìš”.</td></tr>`;
      return;
    }

    orderIdEl.textContent = orderId;

    try {
      const res = await fetch(CHECKOUT_API(orderId, customerId), { credentials: 'include' });
      if (!res.ok) throw new Error('ì£¼ë¬¸ì„œ ì¡°íšŒ ì‹¤íŒ¨');
      ORDER = await res.json(); // âœ… ë°”ê¹¥ì˜ let ORDERì— ëŒ€ì…
      renderOrder(ORDER);
    } catch (e) {
      console.error(e);
      itemTbody.innerHTML = `<tr><td colspan="4">ì£¼ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
    }
  }

  function renderOrder(order) {
    const { storeName, orderName, amount, totalQuantity, items = [] } = order;

    storeNameEl.textContent = storeName || '-';
    orderNameEl.textContent = orderName || `${storeName || 'ìŠ¤í† ì–´'} ì£¼ë¬¸`;
    amountViewEl.textContent = `${nf(amount)} ì›`;

    itemTbody.innerHTML = '';
    let localQty = 0;
    items.forEach(it => {
      const line = (it.price || 0) * (it.quantity || 0);
      localQty += (it.quantity || 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.menuName}</td>
        <td class="price">${nf(it.price)}</td>
        <td class="qty">${nf(it.quantity)}</td>
        <td class="lineTotal">${nf(line)}</td>
      `;
      itemTbody.appendChild(tr);
    });

    totalQtyEl.textContent = nf(totalQuantity ?? localQty);
    totalAmtEl.textContent = nf(amount);
  }

  document.getElementById('payBtn').addEventListener('click', async () => {
    if (!ORDER) return alert('ì£¼ë¬¸ì„œë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.');
    try {
      const tp = TossPayments(TOSS_CLIENT_KEY);
      await tp.requestPayment('CARD', {
        amount: ORDER.amount,
        orderId: ORDER.orderId,
        orderName: ORDER.orderName,
        successUrl: SUCCESS_URL, // âœ… customerId ì¿¼ë¦¬ í¬í•¨ (ì„ì‹œ í…ŒìŠ¤íŠ¸ìš©)
        failUrl: FAIL_URL
      });
    } catch (err) {
      console.error(err);
      alert('ê²°ì œë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  });

  document.getElementById('cancelBtn').addEventListener('click', async () => {
    if (!ORDER) return alert('ì£¼ë¬¸ì„œë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.');
    if (!confirm('ì •ë§ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      const res = await fetch(ORDER_CANCEL_API(ORDER.orderId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      });
      if (!res.ok) throw new Error('ì·¨ì†Œ ì‹¤íŒ¨');
      alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      history.back();
    } catch (e) {
      console.error(e);
      alert('ì£¼ë¬¸ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  });

  // âœ… ë”± í•œ ë²ˆë§Œ í˜¸ì¶œ
  loadOrder();
  // // âœ… í™˜ê²½: ê°™ì€ ë„ë©”ì¸/í¬íŠ¸ë¡œ ì„œë¹™ëœë‹¤ê³  ê°€ì • (Gateway ë’¤)
  // const ORIGIN = location.origin;
  //
  // // ğŸ”‘ Toss Payments (í…ŒìŠ¤íŠ¸ìš© í‚¤ë¡œ êµì²´ ê°€ëŠ¥)
  // const TOSS_CLIENT_KEY = "test_ck_Ba5PzR0Arn9bqEYORBDXVvmYnNeD";
  // const SUCCESS_URL = `${ORIGIN}/payments/success`; // Tossê°€ paymentKey, orderId, amountë¥¼ ë¶™ì—¬ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  // const FAIL_URL    = `${ORIGIN}/payments/fail`;    // Tossê°€ code, message, orderIdë¥¼ ë¶™ì—¬ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸

  // âœ… ì„œë²„ API (payment-service)
  // const CHECKOUT_API = (orderId) =>
  //         `${location.origin}/payment/checkout?orderId=${encodeURIComponent(orderId)}&customerId=${encodeURIComponent(customerId)}`;

  // async function loadOrder() {
  //   if (!orderId) {
  //     itemTbody.innerHTML = `<tr><td colspan="4">orderIdê°€ ì—†ìŠµë‹ˆë‹¤. URLì— ?orderId=... ë¡œ ì ‘ê·¼í•˜ì„¸ìš”.</td></tr>`;
  //     return;
  //   }
  //   orderIdEl.textContent = orderId;
  //
  //   try {
  //     // ê²Œì´íŠ¸ì›¨ì´ê°€ X-User-Id í—¤ë”ë¥¼ ì£¼ì…í•œë‹¤ê³  í–ˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ë”°ë¡œ ì„¤ì •í•˜ì§€ ì•ŠìŒ
  //     const res = await fetch(CHECKOUT_API(orderId), { credentials: 'include' });
  //     if (!res.ok) throw new Error('ì£¼ë¬¸ì„œ ì¡°íšŒ ì‹¤íŒ¨');
  //     ORDER = await res.json(); // OrderCheckoutView
  //     renderOrder(ORDER);
  //   } catch (e) {
  //     console.error(e);
  //     itemTbody.innerHTML = `<tr><td colspan="4">ì£¼ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
  //   }
  // }
</script>

</body>
</html>
