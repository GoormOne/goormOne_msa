<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>주문 결제</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Toss Payments SDK -->
  <script src="https://js.tosspayments.com/v1/payment"></script>
  <style>
    :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    body { margin: 0; background:#0b0c10; color:#f5f7fb; }
    .wrap { max-width: 860px; margin: 40px auto; padding: 24px; }
    .card { background:#14161b; border:1px solid #22252c; border-radius:16px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .title { font-size: 22px; margin: 0 0 12px; }
    .sub { color:#aab1bd; margin: 0 0 20px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #22252c; text-align:left; }
    th { color:#cfd6e4; font-weight:600; }
    tfoot td { border-top:1px solid #2a2f37; font-weight:700; }
    .qty, .price, .lineTotal, .right { text-align: right; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; background:#1e2633; color:#a8d0ff; font-size:12px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; margin-top: 18px; }
    .row .box { flex:1; min-width: 220px; background:#101218; border:1px solid #1f2330; border-radius:12px; padding:12px 14px; }
    .label { color:#9aa3b2; font-size:12px; }
    .val { font-size:16px; margin-top:4px; }
    .btns { display:flex; gap:12px; margin-top: 24px; }
    .btn {
      flex:1; padding:14px 16px; border-radius:12px; border:1px solid transparent;
      font-weight:700; cursor:pointer; transition: transform .02s;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background:#3b82f6; color:white; }
    .btn-outline { background:#0b0c10; color:#c6cbd7; border-color:#2c3340; }
    .help { color:#8c94a3; font-size:12px; margin-top: 10px; }
    code { background:#0e1116; padding:2px 6px; border-radius:6px; border:1px solid #1f2330; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 class="title">🧾 주문 확인 & 결제</h1>
    <p class="sub">스토어 <span id="storeName" class="badge"></span> 의 주문 내역입니다.</p>

    <table>
      <thead>
      <tr>
        <th>메뉴명</th>
        <th class="price">가격(KRW)</th>
        <th class="qty">수량</th>
        <th class="lineTotal">금액(KRW)</th>
      </tr>
      </thead>
      <tbody id="itemTbody"></tbody>
      <tfoot>
      <tr>
        <td>총 수량</td>
        <td></td>
        <td class="qty" id="totalQuantity">0</td>
        <td class="lineTotal" id="totalAmount">0</td>
      </tr>
      </tfoot>
    </table>

    <div class="row">
      <div class="box">
        <div class="label">주문명 (orderName)</div>
        <div class="val" id="orderName">-</div>
      </div>
      <div class="box">
        <div class="label">주문번호 (orderId)</div>
        <div class="val" id="orderId">-</div>
      </div>
      <div class="box">
        <div class="label">결제 금액 (amount)</div>
        <div class="val" id="amountView">0 원</div>
      </div>
    </div>

    <div class="btns">
      <button id="payBtn" class="btn btn-primary">결제하기</button>
      <button id="cancelBtn" class="btn btn-outline">결제 취소하기</button>
    </div>

    <p class="help">
      • 주문 전 메뉴와 수량을 잘 확인해주시기 바랍니다. <br/>
      • 문의사항이 있으시면 02-1111-1111로 전화주세요.
    </p>
  </div>
</div>

<script>
  const PAYMENT_API_BASE = "http://localhost:8086";
  const ORIGIN = location.origin;

  // URL 파라미터
  const qs = new URLSearchParams(location.search);
  const orderId    = qs.get("orderId");
  const customerId = qs.get("customerId");

  // Toss
  const TOSS_CLIENT_KEY = "test_ck_Ba5PzR0Arn9bqEYORBDXVvmYnNeD";
  // 게이트웨이 없을 때는 customerId를 쿼리로 같이 넘겨서 서버에서 읽게 함
  const SUCCESS_URL = `${ORIGIN}/payments/success?customerId=${encodeURIComponent(customerId || "")}`;
  const FAIL_URL    = `${ORIGIN}/payments/fail?customerId=${encodeURIComponent(customerId || "")}`;

  // API 경로
  const CHECKOUT_API = (orderId, customerId) =>
          `${PAYMENT_API_BASE}/payments/checkout?orderId=${encodeURIComponent(orderId)}&customerId=${encodeURIComponent(customerId)}`;
  const ORDER_CANCEL_API = (orderId) =>
          `/orders/${encodeURIComponent(orderId)}/cancel`;

  // 엘리먼트
  const storeNameEl   = document.getElementById('storeName');
  const itemTbody     = document.getElementById('itemTbody');
  const totalQtyEl    = document.getElementById('totalQuantity');
  const totalAmtEl    = document.getElementById('totalAmount');
  const orderIdEl     = document.getElementById('orderId');
  const orderNameEl   = document.getElementById('orderName');
  const amountViewEl  = document.getElementById('amountView');

  // 화면 상태
  let ORDER = null; // 서버에서 받은 주문서

  const nf = (n) => Number(n || 0).toLocaleString('ko-KR');

  async function loadOrder() {
    if (!orderId || !customerId) {
      itemTbody.innerHTML =
              `<tr><td colspan="4">orderId 또는 customerId가 없습니다. URL에 ?orderId=...&customerId=... 로 접근하세요.</td></tr>`;
      return;
    }

    orderIdEl.textContent = orderId;

    try {
      const res = await fetch(CHECKOUT_API(orderId, customerId), { credentials: 'include' });
      if (!res.ok) throw new Error('주문서 조회 실패');
      ORDER = await res.json(); // ✅ 바깥의 let ORDER에 대입
      renderOrder(ORDER);
    } catch (e) {
      console.error(e);
      itemTbody.innerHTML = `<tr><td colspan="4">주문서를 불러오지 못했습니다.</td></tr>`;
    }
  }

  function renderOrder(order) {
    const { storeName, orderName, amount, totalQuantity, items = [] } = order;

    storeNameEl.textContent = storeName || '-';
    orderNameEl.textContent = orderName || `${storeName || '스토어'} 주문`;
    amountViewEl.textContent = `${nf(amount)} 원`;

    itemTbody.innerHTML = '';
    let localQty = 0;
    items.forEach(it => {
      const line = (it.price || 0) * (it.quantity || 0);
      localQty += (it.quantity || 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.menuName}</td>
        <td class="price">${nf(it.price)}</td>
        <td class="qty">${nf(it.quantity)}</td>
        <td class="lineTotal">${nf(line)}</td>
      `;
      itemTbody.appendChild(tr);
    });

    totalQtyEl.textContent = nf(totalQuantity ?? localQty);
    totalAmtEl.textContent = nf(amount);
  }

  document.getElementById('payBtn').addEventListener('click', async () => {
    if (!ORDER) return alert('주문서를 먼저 불러와 주세요.');
    try {
      const tp = TossPayments(TOSS_CLIENT_KEY);
      await tp.requestPayment('CARD', {
        amount: ORDER.amount,
        orderId: ORDER.orderId,
        orderName: ORDER.orderName,
        successUrl: SUCCESS_URL, // ✅ customerId 쿼리 포함 (임시 테스트용)
        failUrl: FAIL_URL
      });
    } catch (err) {
      console.error(err);
      alert('결제를 진행할 수 없습니다. 잠시 후 다시 시도해주세요.');
    }
  });

  document.getElementById('cancelBtn').addEventListener('click', async () => {
    if (!ORDER) return alert('주문서를 먼저 불러와 주세요.');
    if (!confirm('정말 주문을 취소하시겠습니까?')) return;
    try {
      const res = await fetch(ORDER_CANCEL_API(ORDER.orderId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      });
      if (!res.ok) throw new Error('취소 실패');
      alert('주문이 취소되었습니다.');
      history.back();
    } catch (e) {
      console.error(e);
      alert('주문 취소에 실패했습니다.');
    }
  });

  // ✅ 딱 한 번만 호출
  loadOrder();
  // // ✅ 환경: 같은 도메인/포트로 서빙된다고 가정 (Gateway 뒤)
  // const ORIGIN = location.origin;
  //
  // // 🔑 Toss Payments (테스트용 키로 교체 가능)
  // const TOSS_CLIENT_KEY = "test_ck_Ba5PzR0Arn9bqEYORBDXVvmYnNeD";
  // const SUCCESS_URL = `${ORIGIN}/payments/success`; // Toss가 paymentKey, orderId, amount를 붙여서 리다이렉트
  // const FAIL_URL    = `${ORIGIN}/payments/fail`;    // Toss가 code, message, orderId를 붙여서 리다이렉트

  // ✅ 서버 API (payment-service)
  // const CHECKOUT_API = (orderId) =>
  //         `${location.origin}/payment/checkout?orderId=${encodeURIComponent(orderId)}&customerId=${encodeURIComponent(customerId)}`;

  // async function loadOrder() {
  //   if (!orderId) {
  //     itemTbody.innerHTML = `<tr><td colspan="4">orderId가 없습니다. URL에 ?orderId=... 로 접근하세요.</td></tr>`;
  //     return;
  //   }
  //   orderIdEl.textContent = orderId;
  //
  //   try {
  //     // 게이트웨이가 X-User-Id 헤더를 주입한다고 했으므로, 여기서는 따로 설정하지 않음
  //     const res = await fetch(CHECKOUT_API(orderId), { credentials: 'include' });
  //     if (!res.ok) throw new Error('주문서 조회 실패');
  //     ORDER = await res.json(); // OrderCheckoutView
  //     renderOrder(ORDER);
  //   } catch (e) {
  //     console.error(e);
  //     itemTbody.innerHTML = `<tr><td colspan="4">주문서를 불러오지 못했습니다.</td></tr>`;
  //   }
  // }
</script>

</body>
</html>
